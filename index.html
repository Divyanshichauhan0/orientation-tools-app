<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover"
  />
  <title>Orientation Modes: Alarm • Timer • Stopwatch • Weather</title>
  <meta name="theme-color" content="#101218" />
  <style>
    :root {
      --bg: #0f1218;
      --fg: #eaf2ff;
      --dim: #9fb3c8;
      --accent: #5bd7ff;
      --ok: #67f0a7;
      --warn: #ffd166;
      --bad: #ff6b6b;
      --card: #161b23;
      --muted: #0a0d12;
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; margin: 0; background: var(--bg); color: var(--fg); font: 15px/1.5 Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial; }
    .app {
      min-height: 100%;
      display: grid;
      grid-template-rows: auto 1fr auto;
    }
    header {
      display: flex; align-items: center; justify-content: space-between;
      padding: 12px 16px; border-bottom: 1px solid #1f2733; background: linear-gradient(180deg, #121722, #0d1118);
      position: sticky; top: 0; z-index: 5;
    }
    .title { font-weight: 600; letter-spacing: 0.2px; color: var(--fg); }
    .badge {
      padding: 6px 10px; border-radius: 999px; background: #0b1922; color: var(--accent); border: 1px solid #123447;
      font-weight: 600; font-size: 13px;
    }

    main { padding: 16px; display: grid; gap: 16px; }
    .panel {
      display: none;
      background: var(--card); border: 1px solid #1e2835; border-radius: 12px; padding: 14px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.35);
    }
    .panel.active { display: block; }
    .panel h2 { margin: 0 0 8px 0; font-size: 16px; color: var(--fg); }
    .muted { color: var(--dim); }

    .grid2 { display: grid; grid-template-columns: repeat(2, minmax(0,1fr)); gap: 10px; }
    .row { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
    .time {
      font: 600 36px/1.2 ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      letter-spacing: 1px; color: #e9f3ff;
    }
    .sub { font: 12px; color: var(--dim); }

    button, input, select {
      font: 14px Inter, ui-sans-serif, system-ui;
      color: var(--fg);
    }
    button {
      padding: 8px 12px; background: #0f2a3a; border: 1px solid #214a62; border-radius: 8px; cursor: pointer;
    }
    button:hover { background: #113246; }
    button.ghost { background: transparent; border-color: #2a3647; color: var(--dim); }
    input[type="time"], input[type="number"] {
      background: #0e141c; border: 1px solid #223042; border-radius: 8px; padding: 8px 10px;
    }
    .fab {
      position: fixed; bottom: 14px; left: 14px; z-index: 10;
      background: #0c2130; border: 1px solid #20465e; color: var(--accent); border-radius: 999px; padding: 10px 14px;
      box-shadow: 0 10px 24px rgba(0,0,0,0.45);
    }
    .toast {
      position: fixed; bottom: 14px; right: 14px; z-index: 10;
      background: #0d1b28; border: 1px solid #193144; color: var(--fg); padding: 8px 12px; border-radius: 8px; display: none;
    }

    /* Diagnostics (toggle by setting diagnostics=true) */
    #diag {
      position: fixed; top: 8px; left: 8px; z-index: 20;
      background: rgba(0,0,0,0.7); color: #9ef; padding: 8px 10px; border-radius: 6px; font: 12px/1.35 ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      max-width: 92vw; white-space: pre-wrap; display: none;
    }
    #diag .ok { color: #bfffb5; } #diag .warn { color: #ffe08a; } #diag .bad { color: #ffb0b0; }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div class="title">Orientation Modes</div>
      <div class="badge" id="modeBadge">Mode: Alarm</div>
    </header>

    <main>
      <section id="panel-alarm" class="panel active">
        <h2>Alarm</h2>
        <div class="row">
          <label class="muted">Time</label>
          <input id="alarmTime" type="time" step="60" />
          <button id="alarmSetBtn">Set alarm</button>
          <button id="alarmClearBtn" class="ghost">Clear</button>
        </div>
        <div class="row"><span class="sub" id="alarmStatus">No alarm set</span></div>
      </section>

      <section id="panel-stopwatch" class="panel">
        <h2>Stopwatch</h2>
        <div class="row">
          <div class="time" id="swTime">00:00.00</div>
        </div>
        <div class="row">
          <button id="swStart">Start</button>
          <button id="swLap" class="ghost">Lap</button>
          <button id="swReset" class="ghost">Reset</button>
        </div>
        <div class="grid2" id="swLaps"></div>
      </section>

      <section id="panel-timer" class="panel">
        <h2>Timer</h2>
        <div class="row">
          <label class="muted">Minutes</label><input id="tmMin" type="number" min="0" max="999" value="0" style="width:80px" />
          <label class="muted">Seconds</label><input id="tmSec" type="number" min="0" max="59" value="30" style="width:80px" />
          <button id="tmStart">Start</button>
          <button id="tmPause" class="ghost">Pause</button>
          <button id="tmReset" class="ghost">Reset</button>
        </div>
        <div class="row"><div class="time" id="tmRemain">00:30</div></div>
      </section>

      <section id="panel-weather" class="panel">
        <h2>Weather</h2>
        <div class="row"><button id="wxRefresh">Refresh</button><span class="sub" id="wxStatus">Waiting for location…</span></div>
        <div class="row"><div class="time" id="wxTemp">-- °C</div></div>
        <div class="row"><div id="wxMeta" class="muted">—</div></div>
      </section>
    </main>

    <footer style="padding:10px 16px; border-top: 1px solid #1f2733; color: var(--dim);">
      Rotate your device to switch features. Portrait = Alarm • Landscape = Stopwatch • Upside‑down = Timer • Opposite Landscape = Weather.
    </footer>
  </div>

  <button id="enableBtn" class="fab" title="Enable audio for alarm/timer">Enable audio</button>
  <div class="toast" id="toast"></div>
  <div id="diag"></div>

  <script>
    // --- Config ---
    const diagnostics = false; // set true to show live orientation diagnostics

    // --- Small helpers ---
    const $ = sel => document.querySelector(sel);
    function toast(msg, ms=2000){ const el=$('#toast'); el.textContent=msg; el.style.display='block'; clearTimeout(toast._t); toast._t=setTimeout(()=>el.style.display='none', ms); }

    // --- Audio (needed for alarm/timer beeps on mobile) ---
    let audioCtx = null;
    let beepNode = null;
    function ensureAudio(){
      if (!audioCtx) {
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      }
      // pre-create a simple beep function using oscillator + gain
      if (!beepNode) {
        const gain = audioCtx.createGain(); gain.gain.value = 0; gain.connect(audioCtx.destination);
        const osc = audioCtx.createOscillator(); osc.type = 'sine'; osc.frequency.setValueAtTime(880, audioCtx.currentTime); osc.connect(gain); osc.start();
        beepNode = {gain, osc};
        beepNode.beep = (dur=0.2, freq=880) => {
          const t = audioCtx.currentTime;
          beepNode.osc.frequency.setValueAtTime(freq, t);
          beepNode.gain.gain.cancelScheduledValues(t);
          beepNode.gain.gain.setValueAtTime(0, t);
          beepNode.gain.gain.linearRampToValueAtTime(0.2, t+0.01);
          beepNode.gain.gain.linearRampToValueAtTime(0.2, t+dur-0.04);
          beepNode.gain.gain.linearRampToValueAtTime(0.0, t+dur);
        };
      }
    }
    function chime(times=3){
      if (!audioCtx) return;
      let delay = 0;
      for (let i=0;i<times;i++){
        setTimeout(()=> beepNode.beep(0.18, 880 + 80*i), delay);
        delay += 260;
      }
    }

    // --- Modes and UI wiring ---
    const Mode = Object.freeze({ Alarm:'Alarm', Stopwatch:'Stopwatch', Timer:'Timer', Weather:'Weather' });
    const panels = {
      [Mode.Alarm]: $('#panel-alarm'),
      [Mode.Stopwatch]: $('#panel-stopwatch'),
      [Mode.Timer]: $('#panel-timer'),
      [Mode.Weather]: $('#panel-weather')
    };
    function setMode(mode){
      for (const [k,el] of Object.entries(panels)) el.classList.toggle('active', k===mode);
      $('#modeBadge').textContent = 'Mode: ' + mode;
      // Optional: slight haptic feedback on supported devices
      if (navigator.vibrate) { navigator.vibrate(12); }
    }

    // --- Stopwatch ---
    (function(){
      const elTime = $('#swTime'), btnStart = $('#swStart'), btnLap = $('#swLap'), btnReset = $('#swReset'), elLaps = $('#swLaps');
      let running=false, startTs=0, acc=0, raf=0;
      function fmt(ms){
        const m = Math.floor(ms/60000), s = Math.floor((ms%60000)/1000), cs = Math.floor((ms%1000)/10);
        return `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}.${String(cs).padStart(2,'0')}`;
      }
      function tick(){
        const now = performance.now();
        elTime.textContent = fmt(acc + (running ? (now - startTs) : 0));
        raf = running ? requestAnimationFrame(tick) : 0;
      }
      btnStart.addEventListener('click', ()=>{
        running = !running;
        if (running){ startTs = performance.now(); btnStart.textContent='Pause'; tick(); }
        else { acc += performance.now() - startTs; btnStart.textContent='Start'; cancelAnimationFrame(raf); raf=0; }
      });
      btnLap.addEventListener('click', ()=>{
        const item = document.createElement('div'); item.className='row'; item.innerHTML = `<span class="muted">Lap</span><strong>${elTime.textContent}</strong>`;
        elLaps.prepend(item);
      });
      btnReset.addEventListener('click', ()=>{
        running=false; acc=0; btnStart.textContent='Start'; elTime.textContent='00:00.00'; cancelAnimationFrame(raf); raf=0; elLaps.innerHTML='';
      });
    })();

    // --- Timer ---
    (function(){
      const elMin=$('#tmMin'), elSec=$('#tmSec'), btnStart=$('#tmStart'), btnPause=$('#tmPause'), btnReset=$('#tmReset'), elRemain=$('#tmRemain');
      let endAt=0, left=0, running=false, raf=0;
      function fmt(ms){ const m=Math.floor(ms/60000), s=Math.max(0,Math.floor((ms%60000)/1000)); return `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`; }
      function tick(){
        const now = performance.now();
        left = Math.max(0, endAt - now);
        elRemain.textContent = fmt(left);
        if (left<=0){ running=false; cancelAnimationFrame(raf); raf=0; chime(4); return; }
        raf = requestAnimationFrame(tick);
      }
      btnStart.addEventListener('click', ()=>{
        const total = Number(elMin.value||0)*60000 + Number(elSec.value||0)*1000;
        if (!running){
          const baseLeft = left>0 ? left : total;
          endAt = performance.now() + baseLeft;
          running = true; tick();
        }
      });
      btnPause.addEventListener('click', ()=>{ running=false; cancelAnimationFrame(raf); raf=0; });
      btnReset.addEventListener('click', ()=>{ running=false; left=0; elRemain.textContent='00:00'; cancelAnimationFrame(raf); raf=0; });
    })();

    // --- Alarm ---
    (function(){
      const elTime = $('#alarmTime'), btnSet = $('#alarmSetBtn'), btnClear = $('#alarmClearBtn'), status = $('#alarmStatus');
      let timeoutId = 0, targetTs = 0;

      function scheduleAlarm(){
        clearTimeout(timeoutId);
        const val = elTime.value;
        if (!val){ status.textContent='No alarm set'; return; }
        const [hh, mm] = val.split(':').map(Number);
        const now = new Date();
        const target = new Date(now);
        target.setHours(hh, mm, 0, 0);
        if (target <= now) target.setDate(target.getDate()+1);
        targetTs = +target;
        const ms = targetTs - +now;
        status.textContent = `Alarm set for ${target.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})} (in ${Math.round(ms/60000)} min)`;
        timeoutId = setTimeout(()=> { chime(6); status.textContent='Ringing!'; }, ms);
      }

      btnSet.addEventListener('click', ()=>{
        if (!audioCtx) toast('Tap “Enable audio” so the alarm can ring.');
        scheduleAlarm();
      });
      btnClear.addEventListener('click', ()=>{ clearTimeout(timeoutId); status.textContent='No alarm set'; });
    })();

    // --- Weather (Open‑Meteo, no key needed) ---
    (function(){
      const btn = $('#wxRefresh'), st = $('#wxStatus'), elTemp = $('#wxTemp'), meta = $('#wxMeta');
      async function loadWeather(){
        try {
          st.textContent = 'Locating…';
          const pos = await new Promise((res, rej)=>{
            navigator.geolocation.getCurrentPosition(res, rej, {enableHighAccuracy:false, timeout:8000, maximumAge:60000});
          });
          const {latitude, longitude} = pos.coords;
          st.textContent = `Lat ${latitude.toFixed(3)}, Lon ${longitude.toFixed(3)}`;
          const url = `https://api.open-meteo.com/v1/forecast?latitude=${latitude}&longitude=${longitude}&current=temperature_2m,relative_humidity_2m,weather_code&timezone=auto`;
          const r = await fetch(url);
          const j = await r.json();
          const t = j?.current?.temperature_2m;
          const rh = j?.current?.relative_humidity_2m;
          elTemp.textContent = (t!=null ? `${Math.round(t)} °C` : '-- °C');
          meta.textContent = (rh!=null ? `Humidity ${rh}%` : '—');
        } catch (e){
          st.textContent = 'Location/Network unavailable';
          elTemp.textContent = '-- °C';
          meta.textContent = 'Grant location permission and try again';
        }
      }
      btn.addEventListener('click', loadWeather);
      // Lazy-load when entering Weather mode
      const observer = new MutationObserver(()=> {
        if (panels[Mode.Weather].classList.contains('active')) loadWeather();
      });
      observer.observe(panels[Mode.Weather], {attributes:true, attributeFilter:['class']});
    })();

    // --- Orientation detection (Android‑robust) ---
    (function(){
      const diag = document.getElementById('diag');
      if (diagnostics) diag.style.display='block';
      const state = { scrAngle:null, winOrient:null, mqPortrait:null, dev:null };
      let lastMode = null, raf=0;

      function normalizeAngle(a){
        // Normalize to [0,360)
        return ((a % 360) + 360) % 360;
      }
      function computeAngle(s){
        // Priority: Screen Orientation API angle -> window.orientation -> sensors -> media query
        if (typeof s.scrAngle === 'number') return normalizeAngle(s.scrAngle);
        if (typeof s.winOrient === 'number') {
          // window.orientation can be -90 on some devices
          const wo = s.winOrient;
          return normalizeAngle(wo);
        }
        if (s.dev){
          const {beta, gamma} = s.dev; // beta: front-back tilt, gamma: left-right
          // Heuristics: wide thresholds to avoid jitter
          if (Math.abs(beta) < 25 && Math.abs(gamma) > 30) return gamma > 0 ? 90 : 270;
          if (beta > 40) return 0;
          if (beta < -40) return 180;
        }
        return s.mqPortrait ? 0 : 90;
      }
      function angleToMode(angle){
        // 0: Alarm, 90: Stopwatch, 180: Timer, 270: Weather
        if (angle >= 315 || angle < 45) return Mode.Alarm;
        if (angle >= 45 && angle < 135) return Mode.Stopwatch;
        if (angle >= 135 && angle < 225) return Mode.Timer;
        return Mode.Weather; // 225-315
      }
      function update(){
        cancelAnimationFrame(raf);
        raf = requestAnimationFrame(()=>{
          const angle = computeAngle(state);
          const mode = angleToMode(angle);
          if (mode !== lastMode){
            lastMode = mode;
            setMode(mode);
          }
          if (diagnostics){
            diag.innerHTML =
`Screen.angle: ${state.scrAngle ?? 'n/a'}
window.orientation: ${state.winOrient ?? 'n/a'}
matchMedia(portrait): ${state.mqPortrait}
DeviceOrientation: ${state.dev ? `β=${state.dev.beta?.toFixed(0)} γ=${state.dev.gamma?.toFixed(0)}` : 'no event'}
Computed angle≈${angle} → ${mode}`;
          }
        });
      }

      function attach(){
        // Screen Orientation API (Android Chrome supports this)
        try {
          const so = screen.orientation;
          if (so && typeof so.addEventListener === 'function'){
            state.scrAngle = typeof so.angle === 'number' ? normalizeAngle(so.angle) : null;
            so.addEventListener('change', ()=>{
              state.scrAngle = typeof so.angle === 'number' ? normalizeAngle(so.angle) : null;
              update();
            });
          }
        } catch {}

        // Legacy window.orientation (some browsers still fire this)
        if ('orientation' in window){
          state.winOrient = Number(window.orientation);
          window.addEventListener('orientationchange', ()=>{
            state.winOrient = Number(window.orientation);
            update();
          }, {passive:true});
        }

        // matchMedia baseline
        const mq = window.matchMedia('(orientation: portrait)');
        state.mqPortrait = mq.matches;
        mq.addEventListener?.('change', e => { state.mqPortrait = e.matches; update(); });

        // DeviceOrientation (Android usually doesn't need permission)
        function onDOF(e){
          state.dev = {
            alpha: (typeof e.alpha === 'number') ? e.alpha : null,
            beta: (typeof e.beta === 'number') ? e.beta : null,
            gamma: (typeof e.gamma === 'number') ? e.gamma : null,
            absolute: !!e.absolute
          };
          update();
        }
        // Clean first to avoid dups on hot reload
        window.removeEventListener('deviceorientation', onDOF);
        try {
          // On Android Chrome, requestPermission is undefined; just attach
          window.addEventListener('deviceorientation', onDOF, {passive:true});
        } catch { /* ignore */ }

        update(); // initial
      }

      attach();
      // Also set an initial heuristic based on matchMedia immediately
      setMode(window.matchMedia('(orientation: portrait)').matches ? Mode.Alarm : Mode.Stopwatch);
    })();

    // --- Enable button (resume audio and attach motion if needed) ---
    (function(){
      const btn = document.getElementById('enableBtn');
      btn.addEventListener('click', async ()=>{
        try {
          ensureAudio();
          if (audioCtx && audioCtx.state === 'suspended') await audioCtx.resume();
          toast('Audio enabled');
          btn.style.display = 'none';
        } catch (e){
          toast('Could not enable audio');
        }
      }, {passive:false});
    })();

    // --- Friendly first-gesture setup (helps audio on Android) ---
    window.addEventListener('click', ()=> {
      if (!audioCtx) { ensureAudio(); audioCtx.resume?.(); }
    }, {once:true});
  </script>
</body>
</html>
